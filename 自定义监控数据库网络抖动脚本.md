# 自定义监控网络检测文档

#### 需求描述：

```
以SDK2.0国内为例，我们的主数据库在腾讯云广州，而我们的LVS分布在腾讯云及华为云，地域分布有上海和广州及香港。

我们目前是依赖业务上面的sql_error日志来判断LVS与数据库服务器之间的连通性的，而刚好我们的SDK业务是持续有用户，所以这个网络连通性也相对持续在检测

假设我们的业务不是连续的，例如我们的盒子系统，一个小时内都没有几个查询的，我们是没有办法感知到LVS与数据库之间的网络是否存在抖动。

为了解决lvs与数据库之间的网络是否可用，需要配合zabbix编写一个脚本进行监控，已更早的发现问题，解决问题。
```



#### 通过zabbix进行实时监控

```
zabbix有很多优秀的模板，模板虽好，但是不能解决所有的监控，有些需要的监控项在模板中并没有，需要我们自己定义一个监控项。

我们需要自己写一个监控的脚本，脚本执行的结果可以让我们知道网络是否可用，抖动的是否很厉害，将写好的脚本交给zabbix来定时运行，并且我们可以通过 WEB 界面设置和查看监视结果，能得到什么时候的时间网络抖动是比较厉害的，最后还可以让zabbix设置一个触发器，也就是当超出我们设定的阈值触发告警，告警可以是电话、邮件等
```



#### 监控脚本具体的执行思路

这里的脚本判断网络检测只要以输出结果 0 或 1 代表网络是否可用，
0为成功，1为失败，再通过zabbix设置触发器，当运行的结果为 =1 时, 触发告警，还可以灵活设置重连几次触发告警邮件，重连几次触发告警电话。

```shell
#!/bin/bash
#这里定义了很多的位置变量传参，可以为不同主机数据库实现网络检测，提高脚本的高可用性，让脚本更加灵活。
Host=$1
#定义ip地址，
User=$2
#定义密码
Passwd=$3
#定义端口号
Port=$4
#定义重连次数，
Connect=$5
#定义睡眠时间
Sleep=$6 
#为接下来能准确判断连接数据库是否正常，需要检测系统是否有nc命令,没有则进行安装
if [ ! $(rpm -qa | grep nmap-ncat* ) ];then yum -y install nc &> /dev/null;fi
#通过nc命令可以指定数据库端口是否开放，若检测到没有开放的端口代表数据库的一端有故障，
#定义一个函数,用于检测端口是否开放，最终返回结果只有 0 or 1 , 0为成功，1为失败
function PortConnect(){
    nc -z $Host $Port 
    echo "$?"
}

#通过mysql -e 命令的方式可以判断本机是否连接得上数据库，并且还能确认是否可以进行查询
#定义一个函数，检测数据库连接的情况，最终返回结果只有 0 or 1 , 0为成功，1为失败
function MysqlConnect(){
    connect=$(mysql -h $Host -u$User -p$Passwd -P$Port -e 'show databases;' &>/dev/null)
    echo "$?"
}

#这里判断数据库端口是否开放，如果没有直接输出 1 触发告警并且退出脚本，也意味着数据库连不上了，没有必要执行下面的步骤
if [ $(PortConnect) != 0 ];then echo 1 && exit ;fi

#定义一个值i，拿来做循环次数递增，原因是需要定义多次的重连，第一次连不上有可能是数据库一端的原因，也可能是网络抖动的原因，所以需要定义多次，当 i 的值等于$connect的值的时候，说明已重连多次，触发告警。
i=1
while (( $i <= $Connect ))
do 
    ConnectionResults=$(MysqlConnect)
    if [ $ConnectionResults != 0 ];then
    #进入if说明连接失败，给i值加1，继续下一次的循环
        let i++
    else
        #进入else说明连接成功，不进行下一次的循环，这里exit直接退出
        echo 0
        exit
    fi
sleep $Sleep
done
echo 1
```

#### zabbix-agent应用脚本

```
Zabbix有很多内置的itemkey,但是这些key都是由Zabbix定义好的比较通用的监控项的实现,
如果我们自己想实现某种特有的非通用型的监控项的话,那么我们就得自己去定义数据收集的命令,并且给它指定一个key,
这种机制就叫做User Parameters(用户参数),所以User Parameters的意义就是实现自定义key

zabbix需要在被监控的主机安装agent的插件才能调用脚本，被监控端的一方需要修改zabbix_agent.conf的配置文
件，添加如下内容：

UserParameter=key,command 
#key：key的值在主机系统中必须是唯一的，其中*代表命令中接受的参数
#command：客户端系统中可执行的命令

例：
UserParameter=connect_test[*],/bin/bash /usr/local/zabbix-4.0-agentd/script/connect_test.sh $1
#新增一个key叫connect_test,[*]代表key接受任意个参数，也是后面命令或脚本中接受的参数，用$1,$2来表示第几个参数，后面跟的就是执行脚本的绝对路径。
#Userparameters就相当于通过脚本要监控的值，然后把相关的脚本或者命令写入到配置文件中的User parameter中然后zabbix server读取配置文件中的返回值通过处理前端的方式返回给用户。


UnsafeUserParameters=1
#这个是开启传参数的意思，允许自定义key，如脚本的位置变量，其中[*]的意思是方括号中可以有任意多的参数，


脚本存放的位置最好是在zabbix_agent的工作目录下的，目录下可以创建script目录以便于管理自定义监控的脚本


定义了User Parameters必须重启zabbix-agent服务

可在zabbix server端执行zabbix_get命令来检查能否采集到数据，判断是否成功
zabbix_get -s 客户端ip -p 端口 -k 想获取的key


```



#### zabbix-UI配置监控项

```
在UI界面上需要给主机绑定我们自定义的监控项、触发器;
为了可以让其他主机也使用脚本，可以直接将自定义的监控项、触发器做在模板里面
创建一个模板，主要修改修改以下内容：
可见的名称 []  #模板名字
群组： [] #将模板加入群组，以方便后续其他主机进行使用
描述 [] #描述此模板具体是监控什么的

在模板内创建监控项，主要注意修改以下的地方：
名称： [] #监控器的名称 这里可以传key值的变量，如： $1 就是相对应脚本第一个位置变量的值
键值：  [] #这里的键值是在agent配置的那一行，#如 connect_test[1，2，3，4，5]
更新间隔： []  #这里定义更新间隔，也就是zabbix多久执行一次脚本

在模板内创建触发器,主要注意修改以下的地方：
表达式： [] # 触发器的本质其实是一个表达式，用来定义监控项的阈值，点击”添加”按钮，即可配置触发器的表达式。
条件里有很多功能，如 last()-最后 (最近)的值，意思是代表最后执行的值如果比上一个值 > < = 就触发告警

最后将需要监控的主机链接到新模板即可完成自定义监控，

```

